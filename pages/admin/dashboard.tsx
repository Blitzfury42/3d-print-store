'use client'; import { useSession, signIn, signOut } from 'next-auth/react'; import { useState, useEffect } from 'react'; import { useRouter } from 'next/router'; import { sendStatusUpdateEmail } from '@/lib/email'; export default function AdminDashboard() { const { data: session, status } = useSession(); const router = useRouter(); const [orders, setOrders] = useState([]); const [loading, setLoading] = useState(true); const [selectedOrder, setSelectedOrder] = useState<any>(null); const [newStatus, setNewStatus] = useState(''); useEffect(() => { if (status === 'unauthenticated') { router.push('/admin/login'); } if (status === 'authenticated') { fetchOrders(); } }, [status]); const fetchOrders = async () => { try { const response = await fetch('/api/admin/orders'); const data = await response.json(); setOrders(data); } catch (error) { console.error('Error fetching orders:', error); } setLoading(false); }; const handleStatusUpdate = async () => { if (!selectedOrder || !newStatus) return; try { await fetch('/api/admin/orders', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({orderId: selectedOrder.id, status: newStatus, message: `Statut mis à jour à: ${newStatus}`,}),}); await sendStatusUpdateEmail(selectedOrder, newStatus); fetchOrders(); setSelectedOrder(null); setNewStatus(''); alert('Commande mise à jour et email envoyé!'); } catch (error) { console.error('Error updating order:', error); alert('Erreur lors de la mise à jour'); } }; if (status === 'loading' || loading) { return <div className="text-center py-12">Chargement...</div>; } if (!session) { return null; } const statuses = ['En attente', 'En production', 'Prêt', 'Livré']; return (<div className="min-h-screen bg-gray-100"><nav className="bg-white shadow"><div className="max-w-7xl mx-auto px-4 py-4 flex justify-between"><h1 className="text-2xl font-bold">Dashboard Admin</h1><button onClick={() => signOut()} className="bg-red-600 text-white px-4 py-2 rounded">Déconnexion</button></div></nav><div className="max-w-7xl mx-auto py-12 px-4"><h2 className="text-3xl font-bold mb-8">Gestion des Commandes</h2>{selectedOrder && (<div className="bg-white rounded-lg shadow mb-8 p-6"><h3 className="text-xl font-bold mb-4">Modifier la commande #{selectedOrder.id}</h3><div className="grid grid-cols-2 gap-4 mb-4"><div><p><strong>Client:</strong> {selectedOrder.customer_name}</p><p><strong>Email:</strong> {selectedOrder.customer_email}</p><p><strong>Quantité:</strong> {selectedOrder.quantity}</p></div><div><p><strong>Couleur:</strong> {selectedOrder.color}</p><p><strong>Prix:</strong> {selectedOrder.total_price}€</p><p><strong>Statut actuel:</strong> {selectedOrder.status}</p></div></div><div className="mb-4"><label className="block text-sm font-medium mb-2">Nouveau statut</label><select value={newStatus} onChange={(e) => setNewStatus(e.target.value)} className="border rounded px-3 py-2 w-full"><option value="">Sélectionner un statut</option>{statuses.map((s) => (<option key={s} value={s}>{s}</option>))}</select></div><div className="flex gap-4"><button onClick={handleStatusUpdate} className="bg-blue-600 text-white px-4 py-2 rounded">Mettre à jour et envoyer email</button><button onClick={() => setSelectedOrder(null)} className="bg-gray-600 text-white px-4 py-2 rounded">Annuler</button></div></div>)}<div className="bg-white rounded-lg shadow overflow-hidden"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-sm font-semibold">ID</th><th className="px-6 py-3 text-left text-sm font-semibold">Client</th><th className="px-6 py-3 text-left text-sm font-semibold">Quantité</th><th className="px-6 py-3 text-left text-sm font-semibold">Couleur</th><th className="px-6 py-3 text-left text-sm font-semibold">Prix</th><th className="px-6 py-3 text-left text-sm font-semibold">Statut</th><th className="px-6 py-3 text-left text-sm font-semibold">Date</th><th className="px-6 py-3 text-left text-sm font-semibold">Action</th></tr></thead><tbody>{orders.map((order: any) => (<tr key={order.id} className="border-t"><td className="px-6 py-4 text-sm">#{order.id}</td><td className="px-6 py-4 text-sm">{order.customer_name}</td><td className="px-6 py-4 text-sm">{order.quantity}</td><td className="px-6 py-4 text-sm">{order.color}</td><td className="px-6 py-4 text-sm font-semibold">{order.total_price}€</td><td className="px-6 py-4 text-sm"><span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">{order.status}</span></td><td className="px-6 py-4 text-sm">{new Date(order.created_at).toLocaleDateString('fr-FR')}</td><td className="px-6 py-4 text-sm"><button onClick={() => setSelectedOrder(order)} className="text-blue-600 hover:underline">Éditer</button></td></tr>))}</tbody></table></div></div></div>); }